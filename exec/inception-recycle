#!/usr/bin/env bash 

function dreamer {
  local b="$1"; shift
  case "$b" in
    plane) echo fischer ;;
    van) echo yusuf ;;
    hotel) echo arthur ;;
    snow) echo eames ;;
  esac
}

function main { 
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile" 
  source inception_common 

  if [[ "$#" == 0 ]]; then
    set -- van virtualbox hotel virtualbox snow virtualbox
  fi

  export LIMBO_LINKED_CLONES=1

  while [[ "$#" != 0 ]]; do
    if [[ "$#" == 1 ]]; then
      set -- "$@" virtualbox
    fi

    b="$1"; shift
    a="$1"; shift

    export INCEPTION_DREAM="$b"
    source "reality_common"
    $b $a recycle
    $b $a lxd init "${BASEBOX_NETWORK_PREFIX}"{0,9}
    $b vagrant ssh -- sudo systemctl restart lxd-bridge
    $b $a docker init "$(dreamer $b)" "$(dreamer $b)" inception/inception0
    "$(dreamer $b)" $a lxd init
  done
}

source sub "$BASH_SOURCE" "$@"
