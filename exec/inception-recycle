#!/usr/bin/env bash 

function dreamer {
  local b="$1"; shift
  case "$dream" in
    plane) echo fischer ;;
    van) echo yusuf ;;
    hotel) echo arthur ;;
    snow) echo eames ;;
  esac
}

function main { 
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile" 
  source inception_common 

  export LIMBO_LINKED_CLONES=1

  set -x

  if [[ "$#" == 0 ]]; then
    set -- plane virtualbox
  fi

  while [[ "$#" != 0 ]]; do
    if [[ "$#" == 1 ]]; then
      set -- "$@" virtualbox
    fi

    dream="$1"; shift
    a="$1"; shift
    dreamer="$(dreamer $dream)"

    export INCEPTION_DREAM="$dream"
    source "reality_common"

    $dream $a recycle

    $dream $a host init dream
    $dream $a container init "$dreamer" inception/inception0

    $dream vagrant ssh -- ln -nfs ../sv/consul service/
    $dream vagrant ssh -- bash -c "$(printf '%q' 'screen -S home-script-server -d -m script/server screen; sleep 5')"
    $dream vagrant ssh -- screen -X -S home-script-server quit
    ssh-keygen -R $dream

    "$dreamer" $a host init dreamer

    local ip_dreamer="$($dream lxc list "$dreamer" --format json | jq -r '.[].state.network.br0.addresses[] | select(.family == "inet").address')"
    ssh-keygen -R "$ip_dreamer" || true
    ssh -o StrictHostKeyChecking=no ubuntu@"$ip_dreamer" -- ln -nfs ../sv/consul service/
    ssh ubuntu@"$ip_dreamer" -- bash -c "$(printf '%q' 'screen -S home-script-server -d -m script/server screen; sleep 5')"
    ssh ubuntu@"$ip_dreamer" -- screen -X -S home-script-server quit
    ssh-keygen -R "$dreamer"
  done
}

source sub "$dreamASH_SOURCE" "$@"
