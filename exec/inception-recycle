#!/usr/bin/env bash 

function main { 
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile" 
  source inception_common 

  if [[ "$#" == 0 ]]; then
    set -- van virtualbox hotel virtualbox snow virtualbox
  fi

  export LIMBO_LINKED_CLONES=1

  while [[ "$#" != 0 ]]; do
    if [[ "$#" == 1 ]]; then
      set -- "$@" virtualbox
    fi

    b="$1"; shift
    a="$1"; shift

    export INCEPTION_DREAM="$b"
    source "reality_common"
    $b $a recycle
    $b $a lxd init "${BASEBOX_NETWORK_PREFIX}"0
    $b vagrant reload
    $b $a docker init inception "${BASEBOX_NETWORK_PREFIX}1" $b "${BASEBOX_NETWORK_PREFIX}9"

    case "$b" in
      plane) dreamer=fischer ;;
      van) dreamer=yusuf ;;
      hotel) dreamer=arthur ;;
      snow) dreamer=eames ;;
    esac
    $b $a docker init "$dreamer" "${BASEBOX_NETWORK_PREFIX}2" "$dreamer" "${BASEBOX_NETWORK_PREFIX}3" inception/inception0
    sleep 10

		$b lxc list --format json \
      | jq -r '.[] | .state.network.eth0.addresses[] | select(.scope == "global") | .address' \
      | while read -r a; do
          $b vagrant ssh -- sudo ip route replace "250.$(echo $a | cut -d. -f3-4).0/24" via "$a"; done
  done
}

source sub "$BASH_SOURCE" "$@"
