#!/usr/bin/env bash

function main {
  local shome="${_inception_home:-"$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"}"
  source "$shome/script/profile"

  set -x

  $INCEPTION destroy -f
  VBoxManage list vms | cut -d'"' -f2 | runmany 'VBoxManage controlvm $1 poweroff || true; VBoxManage unregistervm --delete $1 || true'
  $PLANE rebase
  $PLANE reuse

  $PLANE recycle
  $PLANE swarm primary
  $PLANE docker image rebase
  $PLANE docker image reuse

  $PLANE recycle
  $PLANE swarm primary
  $PLANE docker image import
  $PLANE reuse

  $INCEPTION destroy -f
  VBoxManage list vms | cut -d'"' -f2 | runmany 'VBoxManage controlvm $1 poweroff || true; VBoxManage unregistervm --delete $1 || true'
  $PLANE recycle
  $PLANE destroy -f
}

source sub "$BASH_SOURCE" "$@"
